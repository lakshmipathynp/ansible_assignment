---
hosts: "{{ reqhosts }}"
become: yes
gather_facts: true
vars: 
  ca_cert_file: 
     - "CA1.crt"
     - "CA2.crt"
     - "CA3.crt"
  ca_cert_path: "/usr/local/share/ca-certificates/{{ ca_cert_file }}"
  ca_cert_name: "{{ ca_cert_file.split('.')[0] }}"
tasks: 
  - name: verify the CA certificate validity
    command: openssl x509 -in "{{ item }}" -noout -dates
    register: certificate_validity
    with_items: "{{ca_cert_file}}"

  - name: Display certificate information  
    debug: 
      msg: "{{ item.stdout_lines }}"
    with_items: "{{ certificate_info.results }}"  

  - name: copy CA certificate to target machines Debian
    copy: 
        src: "{{ item }}"
        dest: "{{ ca_cert_path }}"
        mode: '0644'
    with_items: "{{ca_cert_file}}"    
  - name: Install Custom CA certificates on Debian
    command: update-ca-certificates
    when: ansible_os_family == 'Debian' 
  
  - name: Copy CA certificates on target machines RHEL
    copy: 
        src: "{{ item }}"
        dest: "/etc/pki/ca-trust/source/anchors/{{ item }}"
        mode: '0644'
    with_items: "{{ ca_cert_file }}"   
  - name: Update CA trust store
    command: update-ca-trust extract    
    when: ansible_os_family == 'RedHat'